<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eTracker Admin Dashboard</title>
  <link rel="stylesheet" href="User.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

</head>
<body>

    
  <div class="sidebar">
    <h2>eTracker Admin</h2>
    <a href="Dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="User.html"><i class="fas fa-users"></i> User Management</a>
    <a href="Programs.html"><i class="fas fa-calendar-alt"></i> Program Schedule</a>
    <a href="Attendance.html"><i class="fas fa-check-square"></i> Attendance Tracker</a>
    <a href="Evaluation.html"><i class="fas fa-poll"></i> Evaluation & Feedback</a>
    <a href="Reports.html"><i class="fas fa-chart-bar"></i> Reports & Analytics</a>
    <a href="Document.html"><i class="fas fa-folder"></i> Document Management</a>
    <a href="Certificates.html"><i class="fas fa-certificate"></i> Certificates</a>

  </div>

  <div class="main">
    <div class="user-management">
        <h1>User Management</h1>
      
        <!-- Student Section -->
        <section class="user-section">
          <h2>Students</h2>
          <div class="user-actions">
            <button class="btn-primary" onclick="openModal('add-student-modal')">
                <i class="fas fa-user-plus"></i> Add Student
              </button>
                          <button class="btn-secondary"><i class="fas fa-download"></i> Export Students</button>
          </div>
      
          <!-- Add Student -->

 
  
          <div class="user-table">
            <table>
              <thead>
                <tr>
                  <th>Full Name</th>
                  <th>ID Number</th>
                  <th>Course</th>
                  <th>Contact</th>
                  <th>Enrolled Programs</th>
                  <th>Attendance %</th>
                  <th>Evaluations</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Leave empty, JS will fill this -->
              </tbody>
            </table>
          </div>
        </section>
      
        <!-- Faculty Section -->
        <section class="user-section">
          <h2>Faculty</h2>
          <div class="user-actions">
            <button class="btn-primary" onclick="openModal('add-faculty-modal')">
                <i class="fas fa-user-plus"></i> Add Faculty
              </button>
                          <button class="btn-secondary"><i class="fas fa-download"></i> Export Faculty</button>
          </div>
      
          <div class="user-table">
            <table>
              <thead>
                <tr>
                  <th>Full Name</th>
                  <th>Department</th>
                  <th>Email</th>
                  <th>Programs Handled</th>
                  <th>Students Enrolled</th>
                  <th>Evaluations Given</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Leave empty, JS will fill this -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
      
      <!-- Overlay -->
<div id="modal-overlay" class="modal-overlay hidden"></div>

<!-- Add Student Modal -->
<div id="add-student-modal" class="modal hidden">
  <div class="modal-header">
    <h2>Add Student</h2>
    <span class="close-modal" onclick="closeModal('add-student-modal')">&times;</span>
  </div>
  <form class="modal-form" id="add-student-form" onsubmit="return submitStudent(event)">
    <input type="text" name="firstname" placeholder="First Name" required autocomplete="given-name" />
    <input type="text" name="lastname" placeholder="Last Name" required autocomplete="family-name" />
    <input type="text" name="mi" placeholder="Middle Initial" autocomplete="additional-name" />
    <input type="email" name="email" placeholder="Email" required autocomplete="username" />
    <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
    <input type="text" name="department" placeholder="Course/Department" required />
    <input type="tel" name="phone" placeholder="Phone Number" />
    <select name="comm_preference">
      <option value="" disabled selected>Select Communication Preference</option>
      <option value="email">Email</option>
      <option value="sms">SMS</option>
    </select>
    <select name="programs[]" id="add-programs" multiple required>
      <!-- JS will populate options -->
    </select>
    <button type="submit" class="btn-primary full">Add Student</button>
  </form>
</div>

<!-- Add Faculty Modal -->
<div id="add-faculty-modal" class="modal hidden">
  <div class="modal-header">
    <h2>Add Faculty</h2>
    <span class="close-modal" onclick="closeModal('add-faculty-modal')">&times;</span>
  </div>
  <form class="modal-form" id="add-faculty-form" onsubmit="return submitFaculty(event)">
    <input type="text" name="fullname" placeholder="Full Name" required />
    <input type="text" name="faculty_id" placeholder="Faculty ID" required />
    <input type="text" name="firstname" placeholder="First Name" required />
    <input type="text" name="lastname" placeholder="Last Name" required />
    <input type="text" name="mi" placeholder="Middle Initial" />
    <input type="email" name="email" placeholder="Email" required />
    <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
    <select name="department" required>
      <option value="" disabled selected>Select Department</option>
      <option>Department of Hospitality Management</option>
      <option>Department of Language and Mass Communication</option>
      <option>Department of Physical Education</option>
      <option>Department of Social Sciences and Humanities</option>
      <option>Teacher Education Department</option>
      <option>Department of Administration - ENTREP</option>
      <option>Department of Administration - BSOA</option>
      <option>Department of Administration - BM</option>
      <option>Department of Computer Studies</option>
    </select>
    <input type="tel" name="phone" placeholder="Phone Number" />
    <input type="text" name="position" placeholder="Position" />
    <p><strong>Communication Preference:</strong></p>
    <select name="comm_preference">
      <option value="email">Email</option>
      <option value="sms">SMS</option>
    </select>
    <button type="submit" class="btn-primary full">Add Faculty</button>
  </form>
</div>
  

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal hidden">
  <div class="modal-header">
    <h2>Edit User</h2>
    <span class="close-modal" onclick="closeModal('edit-user-modal')">&times;</span>
  </div>
  <form class="modal-form" id="edit-user-form" onsubmit="return submitEditUser(event)">
    <input type="hidden" name="id" id="edit-id" />
    <input type="text" name="firstname" id="edit-firstname" placeholder="First Name" required />
    <input type="text" name="lastname" id="edit-lastname" placeholder="Last Name" required />
    <input type="text" name="mi" id="edit-mi" placeholder="Middle Initial" />
    <input type="email" name="email" id="edit-email" placeholder="Email" required />
    <input type="text" name="department" id="edit-department" placeholder="Department/Course" required />
    <input type="tel" name="phone" id="edit-phone" placeholder="Phone Number" />
    <select name="comm_preference" id="edit-comm_preference">
      <option value="email">Email</option>
      <option value="sms">SMS</option>
    </select>
    <select name="role" id="edit-role" required>
      <option value="student">Student</option>
      <option value="faculty">Faculty</option>
    </select>
    <select name="programs[]" id="edit-programs" multiple required>
      <!-- JS will populate options -->
    </select>
    <button type="submit" class="btn-edit full">Save Changes</button>
  </form>
</div>

<!-- View Profile Modal -->
<div id="view-profile-modal" class="modal hidden">
    <div class="modal-header">
      <h2>User Profile</h2>
      <span class="close-modal" onclick="closeModal('view-profile-modal')">&times;</span>
    </div>
    <div class="modal-profile">
      <p><strong>Full Name:</strong> <span id="profile-name">Loading...</span></p>
      <p><strong>Role:</strong> <span id="profile-role">-</span></p>
      <p><strong>ID/Faculty Code:</strong> <span id="profile-id">-</span></p>
      <p><strong>Course/Department:</strong> <span id="profile-dept">-</span></p>
      <p><strong>Email:</strong> <span id="profile-email">-</span></p>
      <p><strong>Phone:</strong> <span id="profile-phone">-</span></p>
      <p><strong>Programs:</strong> <span id="profile-programs">-</span></p>
      <p><strong>Attendance:</strong> <span id="profile-attendance">-</span></p>
      <p><strong>Evaluations:</strong> <span id="profile-evaluations">-</span></p>
    </div>
  </div>
  
      
  
   
  </div>

  <script>
    function openModal(id) {
      document.getElementById('modal-overlay').classList.remove('hidden');
      document.getElementById(id).classList.remove('hidden');
    }
  
    function closeModal(id) {
      document.getElementById('modal-overlay').classList.add('hidden');
      document.getElementById(id).classList.add('hidden');
    }
  
    function openViewProfile(user) {
    // Set modal content dynamically
    document.getElementById("profile-name").textContent = user.name;
    document.getElementById("profile-role").textContent = user.role;
    document.getElementById("profile-id").textContent = user.id;
    document.getElementById("profile-dept").textContent = user.department;
    document.getElementById("profile-email").textContent = user.email;
    document.getElementById("profile-phone").textContent = user.phone;
    document.getElementById("profile-programs").textContent = user.programs ? user.programs.join(", ") : "-";
    document.getElementById("profile-attendance").textContent = user.attendance;
    document.getElementById("profile-evaluations").textContent = user.evaluations;

    openModal('view-profile-modal');
  }
  

  document.getElementById('modal-overlay').addEventListener('click', function () {
  ['add-student-modal', 'edit-user-modal', 'add-faculty-modal', 'view-profile-modal'].forEach(id => closeModal(id));
});


// Fetch and display students
function loadStudents() {
  fetch('api_users.php?role=student')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const tbody = document.querySelector('.user-section:nth-of-type(1) tbody');
        tbody.innerHTML = '';
        data.data.forEach(user => {
          tbody.innerHTML += `
            <tr>
              <td>${user.firstname} ${user.lastname}</td>
              <td>${user.id}</td>
              <td>${user.department}</td>
              <td>${user.phone}</td>
              <td>${user.programs ? user.programs.join(", ") : "-"}</td>
              <td>-</td>
              <td>-</td>
              <td>
                <button class="btn-view" onclick='openViewProfile({
                  name: "${user.firstname} ${user.lastname}",
                  role: "Student",
                  id: "${user.id}",
                  department: "${user.department}",
                  email: "${user.email}",
                  phone: "${user.phone}",
                  programs: [],
                  attendance: "-",
                  evaluations: "-"
                })'>View</button>
                <button class="btn-edit" onclick="editUser(${user.id})">Edit</button>
                <button class="btn-delete" onclick="deleteUser(${user.id})">Delete</button>
              </td>
            </tr>
          `;
        });
      }
    });
}

// Fetch and display faculty
function loadFaculty() {
  fetch('api_users.php?role=faculty')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const tbody = document.querySelector('.user-section:nth-of-type(2) tbody');
        tbody.innerHTML = '';
        data.data.forEach(user => {
          tbody.innerHTML += `
            <tr>
              <td>${user.firstname} ${user.lastname}</td>
              <td>${user.department}</td>
              <td>${user.email}</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>
                <button class="btn-view" onclick='openViewProfile({
                  name: "${user.firstname} ${user.lastname}",
                  role: "Faculty",
                  id: "${user.id}",
                  department: "${user.department}",
                  email: "${user.email}",
                  phone: "${user.phone}",
                  programs: [],
                  attendance: "-",
                  evaluations: "-"
                })'>View</button>
                <button class="btn-edit" onclick="editUser(${user.id})">Edit</button>
                <button class="btn-delete" onclick="deleteUser(${user.id})">Delete</button>
              </td>
            </tr>
          `;
        });
      }
    });
}

// Call on page load
window.onload = function() {
  loadStudents();
  loadFaculty();
};

// Add Student
function submitStudent(e) {
  e.preventDefault();
  const form = document.getElementById('add-student-form');
  const data = new FormData(form);
  data.append('role', 'student');
  data.append('action', 'add_user');
  fetch('api_users.php', { method: 'POST', body: data })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        closeModal('add-student-modal');
        loadStudents();
        form.reset();
      }
    });
  return false;
}

// Add Faculty
function submitFaculty(e) {
  e.preventDefault();
  const form = document.getElementById('add-faculty-form');
  const data = new FormData(form);
  data.append('role', 'faculty');
  data.append('action', 'add_user');
  fetch('api_users.php', { method: 'POST', body: data })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        closeModal('add-faculty-modal');
        loadFaculty();
        form.reset();
      }
    });
  return false;
}

function editUser(id) {
  // Fetch user data (including program IDs)
  fetch('api_users.php?id=' + id)
    .then(res => res.json())
    .then(data => {
      if (data.success && data.data.length > 0) {
        const user = data.data[0];
        document.getElementById('edit-id').value = user.id;
        document.getElementById('edit-firstname').value = user.firstname;
        document.getElementById('edit-lastname').value = user.lastname;
        document.getElementById('edit-mi').value = user.mi;
        document.getElementById('edit-email').value = user.email;
        document.getElementById('edit-department').value = user.department;
        document.getElementById('edit-phone').value = user.phone;
        document.getElementById('edit-comm_preference').value = user.comm_preference;
        document.getElementById('edit-role').value = user.role;

        // Fetch all active programs and pre-select user's enrolled programs
        fetch('api_users.php?action=get_programs')
          .then(res => res.json())
          .then(programData => {
            if (programData.success) {
              const select = document.getElementById('edit-programs');
              select.innerHTML = '';
              // user.programs should be an array of program names or IDs
              // If you store names, you need to map names to IDs
              // It's better to return IDs from your backend!
              const userProgramNames = user.programs || [];
              const userProgramIds = user.program_ids || [];
              programData.data.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.program_name;
                // If your user.programs is an array of names:
                if (userProgramNames.includes(program.program_name)) {
                  option.selected = true;
                }
                // If your user.programs is an array of IDs, use:
                if (userProgramIds.includes(program.id)) {
                  option.selected = true;
                }
                select.appendChild(option);
              });
            }
          });

        openModal('edit-user-modal');
      }
    });
}

function deleteUser(id) {
  if (confirm('Are you sure you want to delete this user?')) {
    fetch('api_users.php', {
      method: 'POST',
      body: new URLSearchParams({
        action: 'delete_user',
        id: id
      })
    })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        loadStudents();
        loadFaculty();
      } else {
        alert('Failed to delete user.');
      }
    });
  }
}

function submitEditUser(e) {
  e.preventDefault();
  const form = document.getElementById('edit-user-form');
  const data = new FormData(form);
  data.append('action', 'update_user');
  fetch('api_users.php', { method: 'POST', body: data })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        closeModal('edit-user-modal');
        loadStudents();
        loadFaculty();
      } else {
        alert('Failed to update user.');
      }
    });
  return false;
}

function populatePrograms(selectId, selected = []) {
  fetch('api_users.php?action=get_programs')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        data.data.forEach(program => {
          const option = document.createElement('option');
          option.value = program.id;
          option.textContent = program.program_name;
          if (selected.includes(program.id)) option.selected = true;
          select.appendChild(option);
        });
      }
    });
}

// Call this when opening Add/Edit modals:
populatePrograms('add-programs');
populatePrograms('edit-programs', [/* array of selected program ids */]);
  </script>
  
</body>
</html>
