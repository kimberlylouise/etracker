<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eTracker Admin Dashboard</title>
  <link rel="stylesheet" href="Evaluation.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>eTracker Admin</h2>
    <a href="Dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="User.html"><i class="fas fa-users"></i> User Management</a>
    <a href="Programs.html"><i class="fas fa-calendar-alt"></i> Program Schedule</a>
    <a href="Attendance.html"><i class="fas fa-check-square"></i> Attendance Tracker</a>
    <a href="Evaluation.html"><i class="fas fa-poll"></i> Evaluation & Feedback</a>
    <a href="Reports.html"><i class="fas fa-chart-bar"></i> Reports & Analytics</a>
    <a href="Document.html"><i class="fas fa-folder"></i> Document Management</a>
    <a href="Certificates.html"><i class="fas fa-certificate"></i> Certificates</a>
  
  </div>

  <div class="main">
    <div class="evaluation-header">
      <h1>Evaluation & Feedback Dashboard</h1>
      <p>Monitor feedback, assess program effectiveness, and generate evaluation reports from students, faculty, stakeholders, and partners.</p>
    </div>
    <section class="evaluation-section">

      <!-- Filters -->
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
        <select id="filterProgram">
          <option value="">All Programs</option>
        </select>
        <input type="date" id="filterStart" />
        <input type="date" id="filterEnd" />
        <input type="text" id="filterStudent" placeholder="Search Student" style="padding:4px 8px;" />
        <button class="btn" onclick="applyFilters()">Apply Filters</button>
        <button class="btn" onclick="resetFilters()">Reset</button>
      </div>

      <!-- Summary -->
      <div id="evalSummary" style="margin-bottom:12px;font-weight:500;"></div>

      <!-- Export Buttons -->
      <div style="margin-bottom:12px;">
        <button class="btn" onclick="exportEvaluations('pdf')"><i class="fas fa-file-pdf"></i> Export to PDF</button>
      </div>

      <!-- Chart -->
      <canvas id="avgRatingChart" height="80" style="margin-bottom:18px;"></canvas>

      <!-- Table -->
      <table class="evaluation-table">
        <thead>
          <tr>
            <th>Program Name</th>
            <th>Type</th>
            <th>Student</th>
            <th>Average Rating</th>
            <th>Date</th>
            <th>Reviewed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate this -->
        </tbody>
      </table>
    </section>
  </div>

<script>
let allEvaluations = [];
let filteredEvaluations = [];

async function fetchEvaluations() {
  const res = await fetch('/backend/get_evaluations.php');
  return res.json();
}

function populateProgramFilter(evaluations) {
  const select = document.getElementById('filterProgram');
  const programs = [...new Set(evaluations.map(ev => ev.program_name).filter(Boolean))];
  select.innerHTML = `<option value="">All Programs</option>` +
    programs.map(p => `<option value="${p}">${p}</option>`).join('');
}

function applyFilters() {
  const prog = document.getElementById('filterProgram').value;
  const start = document.getElementById('filterStart').value;
  const end = document.getElementById('filterEnd').value;
  const student = document.getElementById('filterStudent').value.trim().toLowerCase();

  filteredEvaluations = allEvaluations.filter(ev => {
    let ok = true;
    if (prog && ev.program_name !== prog) ok = false;
    if (start && (!ev.eval_date || ev.eval_date < start)) ok = false;
    if (end && (!ev.eval_date || ev.eval_date > end)) ok = false;
    if (student && (!ev.student_name || !ev.student_name.toLowerCase().includes(student))) ok = false;
    return ok;
  });
  renderEvaluationsTable(filteredEvaluations);
  renderSummary(filteredEvaluations);
  renderChart(filteredEvaluations);
}

function resetFilters() {
  document.getElementById('filterProgram').value = '';
  document.getElementById('filterStart').value = '';
  document.getElementById('filterEnd').value = '';
  document.getElementById('filterStudent').value = '';
  filteredEvaluations = allEvaluations;
  renderEvaluationsTable(filteredEvaluations);
  renderSummary(filteredEvaluations);
  renderChart(filteredEvaluations);
}

function renderSummary(evaluations) {
  const avg = evaluations.length
    ? (evaluations.reduce((sum, ev) => {
        const ratings = [ev.content, ev.facilitators, ev.relevance, ev.organization, ev.experience];
        return sum + ratings.reduce((a, b) => a + Number(b), 0) / ratings.length;
      }, 0) / evaluations.length).toFixed(2)
    : '0.00';
  document.getElementById('evalSummary').textContent =
    `Showing ${evaluations.length} evaluations | Avg. Rating: ${avg}`;
}

function renderEvaluationsTable(evaluations) {
  const tbody = document.querySelector('.evaluation-table tbody');
  tbody.innerHTML = '';
  if (!evaluations.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#888;">No evaluations found.</td></tr>`;
    return;
  }
  evaluations.forEach(ev => {
    const ratings = [ev.content, ev.facilitators, ev.relevance, ev.organization, ev.experience];
    const avg = (ratings.reduce((a, b) => a + Number(b), 0) / ratings.length).toFixed(2);
    tbody.innerHTML += `
      <tr>
        <td>${ev.program_name || 'N/A'}</td>
        <td>Student</td>
        <td>${ev.student_name}</td>
        <td>${avg} / 5</td>
        <td>${ev.eval_date ? ev.eval_date.split(' ')[0] : ''}</td>
        <td>
          <span class="reviewed-status" style="color:${ev.reviewed == 1 ? '#1B472B' : '#888'};">
            ${ev.reviewed == 1 ? 'Reviewed' : 'Pending'}
          </span>
        </td>
        <td>
          <button class="btn-small" onclick="showEvaluationDetails(${ev.id})">View</button>
          ${ev.reviewed == 1 ? '' : `<button class="btn-small" onclick="markReviewed(${ev.id})">Mark as Reviewed</button>`}
        </td>
      </tr>
    `;
  });
}

function renderChart(evaluations) {
  const ctx = document.getElementById('avgRatingChart').getContext('2d');
  if (window.avgRatingChart) window.avgRatingChart.destroy();
  // Group by program
  const progMap = {};
  evaluations.forEach(ev => {
    if (!progMap[ev.program_name]) progMap[ev.program_name] = [];
    const ratings = [ev.content, ev.facilitators, ev.relevance, ev.organization, ev.experience];
    progMap[ev.program_name].push(ratings.reduce((a, b) => a + Number(b), 0) / ratings.length);
  });
  const labels = Object.keys(progMap);
  const data = labels.map(p => {
    const arr = progMap[p];
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  });
  window.avgRatingChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Avg. Rating',
        data,
        backgroundColor: '#1B472B'
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { min: 0, max: 5 } }
    }
  });
}

// Export (dummy, implement backend for real export)
function exportEvaluations(type) {
  if (type !== 'pdf') return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Table headers
  const headers = [["Program Name", "Type", "Student", "Avg. Rating", "Date", "Reviewed"]];
  // Table rows
  const rows = filteredEvaluations.map(ev => {
    const ratings = [ev.content, ev.facilitators, ev.relevance, ev.organization, ev.experience];
    const avg = (ratings.reduce((a, b) => a + Number(b), 0) / ratings.length).toFixed(2);
    return [
      ev.program_name || 'N/A',
      "Student",
      ev.student_name,
      avg + " / 5",
      ev.eval_date ? ev.eval_date.split(' ')[0] : '',
      ev.reviewed == 1 ? "Reviewed" : "Pending"
    ];
  });

  doc.text("Evaluation Report", 14, 14);
  doc.autoTable({
    startY: 20,
    head: headers,
    body: rows,
    styles: { fontSize: 9 }
  });

  doc.save("evaluations.pdf");
}

// Mark as Reviewed (dummy, implement backend for real update)
async function markReviewed(id) {
  // await fetch('/backend/mark_reviewed.php?id=' + id, { method: 'POST' });
  const ev = allEvaluations.find(e => e.id == id);
  if (ev) ev.reviewed = 1;
  applyFilters();
}

// Modal for details
function showEvaluationDetails(id) {
  const ev = allEvaluations.find(e => e.id == id);
  if (!ev) return;
  let modal = document.getElementById('evaluationModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'evaluationModal';
    modal.style.position = 'fixed';
    modal.style.top = 0;
    modal.style.left = 0;
    modal.style.right = 0;
    modal.style.bottom = 0;
    modal.style.background = 'rgba(30,41,59,0.45)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = 1000;
    document.body.appendChild(modal);
  }
  modal.innerHTML = `
    <div style="background:#fff;max-width:400px;width:95%;border-radius:10px;padding:24px 20px;position:relative;">
      <button onclick="document.getElementById('evaluationModal').style.display='none'" style="position:absolute;top:10px;right:16px;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
      <h2 style="margin-top:0;">Evaluation Details</h2>
      <p><strong>Program:</strong> ${ev.program_name || 'N/A'}</p>
      <p><strong>Student:</strong> ${ev.student_name}</p>
      <p><strong>Date:</strong> ${ev.eval_date ? ev.eval_date.split(' ')[0] : ''}</p>
      <ul style="padding-left:18px;">
        <li><strong>Content:</strong> ${ev.content}</li>
        <li><strong>Facilitators:</strong> ${ev.facilitators}</li>
        <li><strong>Relevance:</strong> ${ev.relevance}</li>
        <li><strong>Organization:</strong> ${ev.organization}</li>
        <li><strong>Experience:</strong> ${ev.experience}</li>
      </ul>
      <p><strong>Suggestion:</strong> ${ev.suggestion || '-'}</p>
      <p><strong>Recommend:</strong> ${ev.recommend || '-'}</p>
      <div style="margin-top:16px;">
        <button class="btn-small" onclick="markReviewed(${ev.id})" ${ev.reviewed == 1 ? 'disabled' : ''}>Mark as Reviewed</button>
        <button class="btn-small" onclick="replyToEvaluation(${ev.id})">Reply</button>
      </div>
    </div>
  `;
  modal.style.display = 'flex';
}

// Dummy reply function
function replyToEvaluation(id) {
  alert('Reply functionality is not implemented in this demo.');
}

// Initial load
window.addEventListener('DOMContentLoaded', async () => {
  allEvaluations = await fetchEvaluations();
  filteredEvaluations = allEvaluations;
  populateProgramFilter(allEvaluations);
  renderEvaluationsTable(filteredEvaluations);
  renderSummary(filteredEvaluations);
  renderChart(filteredEvaluations);
});
</script>
</body>
</html>
